<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>N0rb1n</title>
<style>
:root{--bg:#070707;--panel:#0f0f10;--accent:#ff2b2b;--muted:#9a9a9a;}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,monospace}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020202 0%, #0b0b0b 100%);color:#eee}
.header{display:flex;align-items:center;gap:12px;padding:14px 18px;background:transparent;position:sticky;top:0;z-index:20}
.site-name{font-size:20px;font-weight:800;letter-spacing:1px;display:flex;align-items:center;gap:10px}
.glow{color:var(--accent);text-shadow:0 0 8px rgba(255,43,43,0.9),0 0 20px rgba(255,43,43,0.35)}
.online-dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px rgba(255,43,43,0.9)}
.header-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.menu-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;cursor:pointer}
.canvas{max-width:1000px;margin:18px auto;padding:16px}
.menu-panel{position:fixed;left:0;right:0;top:-400px;background:linear-gradient(180deg,#0f0f10,#141414);border-bottom:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6);z-index:30;padding:20px;transition:top 450ms cubic-bezier(.2,.9,.2,1)}
.menu-panel.open{top:0}
.menu-grid{display:flex;gap:8px;align-items:center}
.menu-grid a{color:#ddd;text-decoration:none;padding:8px 10px;border-radius:6px}
.indicator{font-size:13px;color:var(--muted);margin-top:10px}
.search-row{display:flex;gap:8px;margin:18px 0}
.search-row input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
.search-row button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#111;font-weight:700;cursor:pointer}
.card{background:linear-gradient(180deg,#0b0b0b,#0d0d0d);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.paste-title{font-weight:700}
.recent-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.preview-btn{margin-top:8px;padding:8px 10px;border-radius:8px;border:0;background:#1b1b1b;color:#fff;cursor:pointer}
.textarea{width:100%;min-height:180px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.hidden{display:none}
.footer{padding:18px;text-align:center;color:var(--muted)}
.img-thumb{width:100%;height:120px;object-fit:cover;border-radius:8px}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
.btn-muted{background:#1c1c1c;color:#ddd}
.alert{margin-top:10px;padding:10px;border-radius:8px;background:#111;color:#ddd}
.device-badge{display:inline-block;padding:6px 8px;border-radius:8px;background:#101010;border:1px solid rgba(255,255,255,0.03)}
.friend-card{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#0b0b0b}
.chat-box{border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;min-height:180px;overflow:auto;background:#050505}
.msg{padding:8px;border-radius:8px;margin-bottom:8px;max-width:75%}
.msg.you{background:#111;align-self:flex-end}
.msg.them{background:#151515}
.profile-thumb{width:48px;height:48px;border-radius:8px;object-fit:cover}
</style>
</head>
<body>
<div class="header">
  <div class="site-name"><div class="glow">N0rb1n</div><div id="onlineDot" class="online-dot" title="Users online"></div><div id="onlineCount" style="font-weight:700;margin-left:6px">0</div></div>
  <div class="header-right">
    <div id="deviceDisplay" class="device-badge small">device:unknown</div>
    <button id="openMenuBtn" class="menu-btn">☰ Menu</button>
  </div>
</div>

<div id="menuPanel" class="menu-panel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800;font-size:18px">N0rb1n Menu</div>
    <div><button id="closeMenuBtn" class="menu-btn">Close</button></div>
  </div>
  <div class="menu-grid" style="margin-top:12px">
    <a href="#" data-target="home" class="menu-link">Home</a>
    <a href="#" data-target="paste" class="menu-link">Paste</a>
    <a href="#" data-target="signin" class="menu-link" id="menuSignIn">Sign In</a>
    <a href="#" data-target="login" class="menu-link" id="menuLogIn">Log In</a>
    <a href="#" data-target="myaccount" class="menu-link hidden" id="menuMyAccount">My Account</a>
    <a href="#" data-target="hall" class="menu-link">Hall of Autism</a>
    <a href="#" data-target="friends" class="menu-link">Friends</a>
  </div>
</div>

<div class="canvas">
  <div id="appRoot"></div>
</div>

<div class="footer small">N0rb1n — local demo (works in-browser using localStorage)</div>

<script>
/* =====================================
   Lightweight single-file app using localStorage
   Features implemented as requested: header, menu, device detect, home/search, paste creation,
   hall with images for titles published >=3 times, sign-in/login virtual accounts, my account with profile
   friends system with requests/accept/deny, simple chat stored in localStorage, online counter.
   This is a client-side demo — to make truly multi-user you'd need a backend.
   ===================================== */

const STORAGE = {
  USERS: 'n0rb1n_users',
  PASTES: 'n0rb1n_pastes',
  CURRENT: 'n0rb1n_current',
  ACTIVE: 'n0rb1n_active',
};

let state = {currentUser:null, pastes:[],users:{}};

/* ----------------------- util ----------------------- */
function now(){return Date.now()}
function loadJSON(key, fallback){try{return JSON.parse(localStorage.getItem(key))||fallback}catch(e){return fallback}}
function saveJSON(key, val){localStorage.setItem(key, JSON.stringify(val))}

/* ----------------------- online count ----------------------- */
function touchActive(){let list = loadJSON(STORAGE.ACTIVE, {}); list[navigator.userAgent + '_' + (localStorage._n0sessionid||Math.random())] = now(); localStorage._n0sessionid = Object.keys(list).find(k=>k.includes(navigator.userAgent)) || localStorage._n0sessionid; // keep
 // prune >30s
 for(let k in list) if(now()-list[k] > 30000) delete list[k]; saveJSON(STORAGE.ACTIVE,list); updateOnlineUI();}
function updateOnlineUI(){let list = loadJSON(STORAGE.ACTIVE,{}); let count = Object.keys(list).length; document.getElementById('onlineCount').innerText = count;}
setInterval(()=>{touchActive()},5000); touchActive();

/* ----------------------- device detect ----------------------- */
function detectDevice(){let ua=navigator.userAgent.toLowerCase(); let dev='desktop'; if(/android/.test(ua)) dev='android'; else if(/iphone|ipad|ipod/.test(ua)) dev='ios'; else if(/emulator|virtual|genymotion/.test(ua)) dev='vm'; else if(/android.*(wv|okhttp|mobile).*(chrome)/.test(ua)) dev='vp'; return dev}
function updateDeviceUI(){document.getElementById('deviceDisplay').innerText = 'device:' + detectDevice()}
updateDeviceUI();

/* ----------------------- storage load ----------------------- */
function boot(){state.users = loadJSON(STORAGE.USERS,{}) || {}; state.pastes = loadJSON(STORAGE.PASTES,[]) || []; state.currentUser = loadJSON(STORAGE.CURRENT,null); renderRoute('home'); refreshMenuVisibility();}

/* ----------------------- routing & UI ----------------------- */
const root = document.getElementById('appRoot');
function renderRoute(route){root.innerHTML=''; if(route==='home') renderHome(); else if(route==='paste') renderPasteForm(); else if(route==='hall') renderHall(); else if(route==='signin') renderSignIn(); else if(route==='login') renderLogin(); else if(route==='myaccount') renderMyAccount(); else if(route==='friends') renderFriends();}

function renderHome(){const div = document.createElement('div');
  const searchRow = document.createElement('div'); searchRow.className='search-row';
  const input = document.createElement('input'); input.placeholder='Search titles / pastes...'; input.id='searchInput';
  const btn = document.createElement('button'); btn.innerText='Search'; btn.className='';
  searchRow.appendChild(input); searchRow.appendChild(btn);
  const recentContainer = document.createElement('div'); recentContainer.id='recentContainer';
  div.appendChild(searchRow); div.appendChild(recentContainer);

  // recent pastes
  function showRecent(){recentContainer.innerHTML=''; let all = state.pastes.slice().reverse(); if(all.length===0) {recentContainer.innerHTML='<div class="small">No pastes yet</div>'; return;} const list = document.createElement('div'); list.className='recent-list'; all.slice(0,12).forEach(p=>{const c=document.createElement('div'); c.className='card'; c.innerHTML = `<div class="paste-title">${escapeHtml(p.title)}</div><div class="small">by ${p.author||'anon'} • ${new Date(p.created).toLocaleString()}</div>`; if(p.image) c.innerHTML += `<img src="${p.image}" class="img-thumb"/>`; const preview=document.createElement('button'); preview.innerText='Preview'; preview.className='preview-btn'; preview.onclick=()=> openPastePreview(p.id); c.appendChild(preview); list.appendChild(c) }); recentContainer.appendChild(list)}
  showRecent();

  function doSearch(){const q = input.value.trim().toLowerCase(); if(q===''){showRecent(); return;} recentContainer.innerHTML=''; const found = state.pastes.filter(p=>p.title.toLowerCase().includes(q)); if(found.length===0){recentContainer.innerHTML='<div class="small">No results</div>'; return;} const list=document.createElement('div'); list.className='recent-list'; found.forEach(p=>{const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">${escapeHtml(p.title)}</div><div class="small">by ${p.author||'anon'}</div>`; const preview=document.createElement('button'); preview.innerText='Preview'; preview.className='preview-btn'; preview.onclick=()=> openPastePreview(p.id); c.appendChild(preview); list.appendChild(c)}); recentContainer.appendChild(list)}
  btn.addEventListener('click',doSearch); input.addEventListener('input',()=>{ if(input.value.trim()==='') showRecent(); });

  root.appendChild(div);
}

function openPastePreview(id){const p = state.pastes.find(x=>x.id===id); if(!p) return alert('Paste not found'); renderPasteView(p)}

function renderPasteView(paste){root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><div class="paste-title">${escapeHtml(paste.title)}</div><div class="small">by ${paste.author||'anon'} • ${new Date(paste.created).toLocaleString()}</div></div><div><button class="btn btn-muted" id="backHome">Back</button></div></div><hr/>`;
  const content = document.createElement('div'); content.style.whiteSpace='pre-wrap'; content.style.overflow='auto'; content.style.maxHeight='60vh'; content.style.padding='6px'; content.innerText = paste.content;
  c.appendChild(content);
  if(paste.image) c.innerHTML += `<div style="margin-top:10px"><img src="${paste.image}" style="max-width:100%;border-radius:8px"/></div>`;
  root.appendChild(c);
  document.getElementById('backHome').onclick=()=>renderRoute('home');
}

function renderPasteForm(){root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">Create Paste</div><div class="small">Title</div>`;
  const title = document.createElement('input'); title.style.width='100%'; title.style.padding='10px'; title.style.marginTop='8px'; title.placeholder='Title';
  const ta = document.createElement('textarea'); ta.className='textarea'; ta.placeholder='Your paste content — unlimited length';
  const imgRow=document.createElement('div'); imgRow.style.marginTop='8px'; imgRow.innerHTML = `<div class="small">Image (file or URL)</div>`;
  const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
  const urlInput = document.createElement('input'); urlInput.placeholder='Image URL (optional)'; urlInput.style.width='100%'; urlInput.style.marginTop='6px';
  const btnRow=document.createElement('div'); btnRow.style.marginTop='10px';
  const publish=document.createElement('button'); publish.innerText='Publish it'; publish.className='btn'; publish.style.background='var(--accent)'; publish.style.color='#111';
  const clear=document.createElement('button'); clear.innerText='Clear'; clear.className='btn btn-muted'; clear.style.marginLeft='8px';
  const alertBox=document.createElement('div'); alertBox.className='alert hidden';

  btnRow.appendChild(publish); btnRow.appendChild(clear);
  c.appendChild(title); c.appendChild(document.createElement('br')); c.appendChild(document.createElement('br')); c.appendChild(ta); c.appendChild(imgRow); imgRow.appendChild(fileInput); imgRow.appendChild(urlInput); c.appendChild(btnRow); c.appendChild(alertBox);
  root.appendChild(c);

  // file to dataURL
  function readFileAsDataURL(file){return new Promise((res,rej)=>{const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file)})}

  publish.onclick = async ()=>{
    const t = title.value.trim(); const content = ta.value || '';
    if(!t){alertBox.classList.remove('hidden'); alertBox.innerText='Title is required'; return}
    let dataUrl = urlInput.value.trim() || null;
    if(fileInput.files && fileInput.files[0]){try{dataUrl = await readFileAsDataURL(fileInput.files[0])}catch(e){console.warn(e)}}
    const id = 'p_' + Math.random().toString(36).slice(2,9);
    const paste = {id,title:t,content,author: state.currentUser?.username || 'anon',image:dataUrl,created:now()};
    state.pastes.push(paste); saveJSON(STORAGE.PASTES,state.pastes); alertBox.classList.remove('hidden'); alertBox.innerText='Paste created and published'; // show recent instantly
    renderRoute('home');
  }
  clear.onclick=()=>{title.value=''; ta.value=''; urlInput.value=''; fileInput.value=null; alertBox.classList.remove('hidden'); alertBox.innerText='Cleared';}
}

function renderHall(){root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">Hall of Autism</div><div class="small">Titles with 3+ publications show their image and name</div><div id="hallGrid" style="margin-top:10px"></div>`;
  root.appendChild(c);
  const counts = {};
  state.pastes.forEach(p=> { counts[p.title] = counts[p.title] ? counts[p.title]+1 : 1 });
  const hall = [];
  for(const title in counts){ if(counts[title] >= 3){ // find latest paste with image
      const match = state.pastes.slice().reverse().find(p=>p.title===title && p.image); if(match) hall.push({title, image:match.image}) }}
  const grid = document.getElementById('hallGrid'); if(hall.length===0) grid.innerHTML='<div class="small">No repeated titles with images yet</div>'; else{ const list=document.createElement('div'); list.className='recent-list'; hall.forEach(h=>{const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="paste-title">${escapeHtml(h.title)}</div><img src="${h.image}" class="img-thumb"/>`; list.appendChild(el)}); grid.appendChild(list)}
}

function renderSignIn(){root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">Create Account</div><div class="small">Pick username & password</div>`;
  const user=document.createElement('input'); user.placeholder='Username'; user.style.width='100%'; user.style.padding='10px'; user.style.marginTop='8px';
  const pass=document.createElement('input'); pass.placeholder='Password'; pass.type='password'; pass.style.width='100%'; pass.style.padding='10px'; pass.style.marginTop='8px';
  const btn=document.createElement('button'); btn.innerText='Sign In'; btn.className='btn'; btn.style.background='var(--accent)'; btn.style.color='#111';
  const alertBox=document.createElement('div'); alertBox.className='alert hidden';
  c.appendChild(user); c.appendChild(pass); c.appendChild(document.createElement('br')); c.appendChild(document.createElement('br')); c.appendChild(btn); c.appendChild(alertBox);
  root.appendChild(c);
  btn.onclick=()=>{
    const u=user.value.trim(); const p=pass.value;
    if(!u||!p){alertBox.classList.remove('hidden'); alertBox.innerText='Username and password required'; return}
    if(state.users[u]){alertBox.classList.remove('hidden'); alertBox.innerText='Account already exists'; return}
    state.users[u] = {username:u,password:p,avatar:null,friends:[],requests:[]}; saveJSON(STORAGE.USERS,state.users); state.currentUser = {username:u}; saveJSON(STORAGE.CURRENT,state.currentUser); alertBox.classList.remove('hidden'); alertBox.innerText='Account created and signed in'; refreshMenuVisibility(); renderRoute('home');
  }
}

function renderLogin(){root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">Log In</div><div class="small">Enter username & password</div>`;
  const user=document.createElement('input'); user.placeholder='Username'; user.style.width='100%'; user.style.padding='10px'; user.style.marginTop='8px';
  const pass=document.createElement('input'); pass.placeholder='Password'; pass.type='password'; pass.style.width='100%'; pass.style.padding='10px'; pass.style.marginTop='8px';
  const btn=document.createElement('button'); btn.innerText='Log In'; btn.className='btn'; btn.style.background='var(--accent)'; btn.style.color='#111';
  const alertBox=document.createElement('div'); alertBox.className='alert hidden';
  c.appendChild(user); c.appendChild(pass); c.appendChild(document.createElement('br')); c.appendChild(document.createElement('br')); c.appendChild(btn); c.appendChild(alertBox);
  root.appendChild(c);
  btn.onclick=()=>{
    const u=user.value.trim(); const p=pass.value; if(!u||!p){alertBox.classList.remove('hidden'); alertBox.innerText='Provide both'; return}
    if(!state.users[u]){alertBox.classList.remove('hidden'); alertBox.innerText='Account does not exist'; return}
    if(state.users[u].password !== p){alertBox.classList.remove('hidden'); alertBox.innerText='Account password incorrect'; return}
    state.currentUser = {username:u}; saveJSON(STORAGE.CURRENT,state.currentUser); alertBox.classList.remove('hidden'); alertBox.innerText='Logged in'; refreshMenuVisibility(); renderRoute('home');
  }
}

function renderMyAccount(){root.innerHTML=''; if(!state.currentUser){renderRoute('home');return} const u = state.users[state.currentUser.username]; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">My Account — ${escapeHtml(u.username)}</div>`;
  const thumb = document.createElement('img'); thumb.className='profile-thumb'; thumb.src = u.avatar || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"48\" height=\"48\"><rect width=\"100%\" height=\"100%\" fill=\"%230a0a0a\"/></svg>';
  const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*'; fileIn.style.display='block'; fileIn.style.marginTop='8px';
  const urlIn = document.createElement('input'); urlIn.placeholder='Avatar URL (optional)'; urlIn.style.display='block'; urlIn.style.marginTop='8px'; urlIn.style.width='100%';
  const saveBtn = document.createElement('button'); saveBtn.innerText='Save Thumbnail'; saveBtn.className='btn'; saveBtn.style.background='var(--accent)'; saveBtn.style.color='#111'; saveBtn.style.marginTop='10px';
  const logoutBtn = document.createElement('button'); logoutBtn.innerText='Log Out'; logoutBtn.className='btn btn-muted'; logoutBtn.style.marginLeft='8px'; logoutBtn.style.marginTop='10px';
  const alertBox=document.createElement('div'); alertBox.className='alert hidden';
  c.appendChild(thumb); c.appendChild(fileIn); c.appendChild(urlIn); c.appendChild(saveBtn); c.appendChild(logoutBtn); c.appendChild(alertBox);
  root.appendChild(c);
  fileIn.onchange = async ()=>{ if(fileIn.files[0]){ const data = await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(fileIn.files[0])}); thumb.src=data; }}
  saveBtn.onclick = ()=>{ if(urlIn.value.trim()) u.avatar = urlIn.value.trim(); else if(thumb.src) u.avatar = thumb.src; state.users[u.username]=u; saveJSON(STORAGE.USERS,state.users); saveJSON(STORAGE.CURRENT,state.currentUser); alertBox.classList.remove('hidden'); alertBox.innerText='Thumbnail saved'; }
  logoutBtn.onclick = ()=>{ state.currentUser = null; localStorage.removeItem(STORAGE.CURRENT); refreshMenuVisibility(); renderRoute('home'); }
}

function refreshMenuVisibility(){ document.getElementById('menuSignIn').style.display = state.currentUser ? 'none' : 'inline'; document.getElementById('menuLogIn').style.display = state.currentUser ? 'none' : 'inline'; document.getElementById('menuMyAccount').style.display = state.currentUser ? 'inline' : 'none'; }

/* ----------------------- friends & chat ----------------------- */
function renderFriends(){ root.innerHTML=''; const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div class="paste-title">Friends</div><div class="small">Add friends by username, accept/deny requests, chat with friends</div>`;
  const addRow = document.createElement('div'); addRow.style.marginTop='10px'; const addInput=document.createElement('input'); addInput.placeholder='Username to add'; addInput.style.padding='8px'; addInput.style.width='60%'; const addBtn=document.createElement('button'); addBtn.innerText='Add Friend'; addBtn.className='btn btn-muted'; addBtn.style.marginLeft='8px'; addRow.appendChild(addInput); addRow.appendChild(addBtn);
  c.appendChild(addRow);
  const reqTitle = document.createElement('div'); reqTitle.className='small'; reqTitle.style.marginTop='12px'; reqTitle.innerText='Requests'; c.appendChild(reqTitle);
  const reqList = document.createElement('div'); reqList.id='reqList'; reqList.style.marginTop='8px'; c.appendChild(reqList);
  const friendTitle = document.createElement('div'); friendTitle.className='small'; friendTitle.style.marginTop='12px'; friendTitle.innerText='Your Friends'; c.appendChild(friendTitle);
  const friendList = document.createElement('div'); friendList.id='friendList'; friendList.style.marginTop='8px'; c.appendChild(friendList);
  root.appendChild(c);

  function refreshLists(){ reqList.innerHTML=''; friendList.innerHTML=''; const me = state.users[state.currentUser?.username]; if(!me) return; // requests are usernames
    me.requests.forEach(r=>{ const card=document.createElement('div'); card.className='friend-card'; card.innerHTML=`<div style="flex:1">${r}</div>`; const acc=document.createElement('button'); acc.innerText='Accept'; acc.className='btn'; acc.onclick=()=>{ // add to friends both
          if(!me.friends.includes(r)) me.friends.push(r); const other = state.users[r]; if(other && !other.friends.includes(me.username)) other.friends.push(me.username); // remove request
          me.requests = me.requests.filter(x=>x!==r); saveJSON(STORAGE.USERS,state.users); refreshLists(); }
        const den=document.createElement('button'); den.innerText='Deny'; den.className='btn btn-muted'; den.style.marginLeft='6px'; den.onclick=()=>{ me.requests = me.requests.filter(x=>x!==r); saveJSON(STORAGE.USERS,state.users); refreshLists(); }
        card.appendChild(acc); card.appendChild(den); reqList.appendChild(card) });
    me.friends.forEach(f=>{ const card=document.createElement('div'); card.className='friend-card'; const av = state.users[f]?.avatar || ''; card.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${av}" class="profile-thumb" onerror="this.style.display='none'"/><div style="flex:1">${f}</div></div>`; const chatBtn=document.createElement('button'); chatBtn.innerText='Chat now!'; chatBtn.className='btn'; chatBtn.onclick=()=>openChatWith(f); card.appendChild(chatBtn); friendList.appendChild(card) }) }

  addBtn.onclick = ()=>{ const target = addInput.value.trim(); const me = state.users[state.currentUser.username]; if(!target || !state.users[target]) return alert('User not found'); if(target === me.username) return alert('Cannot add yourself'); // send request to target
    const other = state.users[target]; if(!other.requests.includes(me.username) && !other.friends.includes(me.username)){ other.requests.push(me.username); saveJSON(STORAGE.USERS,state.users); alert('Friend request sent'); }
    refreshLists(); }

  refreshLists();
}

function openChatWith(username){ root.innerHTML=''; const convoKey = chatKey(state.currentUser.username, username); const c=document.createElement('div'); c.className='card'; c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div class="paste-title">Chat with ${escapeHtml(username)}</div><div><button id="backFriends" class="btn btn-muted">Back</button></div></div><div style="height:8px"></div>`;
  const chatBox = document.createElement('div'); chatBox.className='chat-box'; chatBox.id='chatBox'; chatBox.style.display='flex'; chatBox.style.flexDirection='column'; chatBox.style.gap='6px'; c.appendChild(chatBox);
  const inputRow=document.createElement('div'); inputRow.style.display='flex'; inputRow.style.gap='8px'; inputRow.style.marginTop='8px'; const inp=document.createElement('input'); inp.style.flex='1'; inp.placeholder='Message...'; const send=document.createElement('button'); send.innerText='Send'; send.className='btn'; inputRow.appendChild(inp); inputRow.appendChild(send); c.appendChild(inputRow);
  root.appendChild(c);
  document.getElementById('backFriends').onclick=()=>renderFriends();
  function loadMsgs(){ const msgs = loadJSON(convoKey,[]); chatBox.innerHTML=''; msgs.forEach(m=>{ const el=document.createElement('div'); el.className='msg '+(m.from===state.currentUser.username?'you':'them'); el.innerText = m.from+': '+m.text; chatBox.appendChild(el); }); chatBox.scrollTop = chatBox.scrollHeight; }
  send.onclick=()=>{ if(!inp.value.trim()) return; const msgs = loadJSON(convoKey,[]); msgs.push({from:state.currentUser.username,text:inp.value.trim(),t:now()}); saveJSON(convoKey,msgs); inp.value=''; loadMsgs(); }
  loadMsgs(); // poll for updates
  const poll = setInterval(loadMsgs,1200);
}

function chatKey(a,b){ const arr=[a,b].sort(); return `chat_${arr[0]}_${arr[1]}` }

/* ----------------------- helpers ----------------------- */
function escapeHtml(s){ if(!s) return ''; return (s+'').replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]})}

/* ----------------------- menu behavior ----------------------- */
const menuPanel = document.getElementById('menuPanel'); document.getElementById('openMenuBtn').addEventListener('click',()=>{ menuPanel.classList.add('open'); menuPanel.setAttribute('aria-hidden','false') }); document.getElementById('closeMenuBtn').addEventListener('click',()=>{ menuPanel.classList.remove('open'); menuPanel.setAttribute('aria-hidden','true') });
// links
document.querySelectorAll('.menu-link').forEach(a=>{a.addEventListener('click', (e)=>{ e.preventDefault(); const t = a.dataset.target; menuPanel.classList.remove('open'); renderRoute(t); })});

/* ----------------------- boot & persistence ----------------------- */
window.addEventListener('storage', ()=>{ // other tabs updated
  state.users = loadJSON(STORAGE.USERS,{}); state.pastes = loadJSON(STORAGE.PASTES,[]); state.currentUser = loadJSON(STORAGE.CURRENT,null); refreshMenuVisibility(); });

// init
boot();

/* ----------------------- utility: escape copy paste & id gen when creating pastes ----------------------- */
(function(){ // ensure IDs on pastes
  state.pastes.forEach(p=>{ if(!p.id) p.id = 'p_'+Math.random().toString(36).slice(2,9) }); saveJSON(STORAGE.PASTES,state.pastes); })();

/* ----------------------- small periodic update to UI elements (online count, recent list) ----------------------- */
setInterval(()=>{ state.pastes = loadJSON(STORAGE.PASTES,[]); state.users = loadJSON(STORAGE.USERS,{}); updateOnlineUI(); },3000);

</script>
</body>
</html>
