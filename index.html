<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>N0rb1n ‚Äî Multi‚ÄëUser Single File</title>
<style>
  :root{--bg:#071025;--panel:#0f1324;--muted:#9aa7c7;--accent:#6c5ce7;--good:#3ee98a;--bad:#ff6b6b;--glass: rgba(255,255,255,.04)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;min-height:100vh;background:linear-gradient(180deg,var(--bg),#040515);color:#e9f0ff}
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);border-bottom:1px solid rgba(255,255,255,.03);position:sticky;top:0;z-index:10}
  .brand{font-weight:800;font-size:20px;background:linear-gradient(90deg,#ff6b6b,#ffd166,#3ee98a,#00d4ff,#6c5ce7);-webkit-background-clip:text;background-clip:text;color:transparent}
  .spacer{flex:1}
  .top-info{font-size:13px;color:var(--muted);display:flex;gap:12px;align-items:center}
  .btn{background:linear-gradient(135deg, rgba(108,92,231,.18), rgba(0,212,255,.08));border:0;padding:8px 12px;border-radius:10px;color:#fff;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.05)}
  .wrap{display:grid;grid-template-columns:260px 1fr;gap:16px;padding:18px}
  aside{background:var(--panel);padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.03)}
  nav a{display:block;padding:10px;border-radius:10px;color:inherit;text-decoration:none;margin-bottom:6px;border:1px solid transparent}
  nav a.active{outline:2px solid rgba(0,212,255,.12);background:linear-gradient(90deg, rgba(108,92,231,.08), rgba(0,212,255,.04))}
  main{min-height:70vh}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.03)}
  input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:flex;gap:10px}
  .tiny{font-size:12px;color:var(--muted)}
  .list .item{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.03);margin-bottom:8px;display:flex;gap:10px;align-items:center}
  .avatar{width:46px;height:46px;border-radius:50%;background:linear-gradient(90deg,#6c5ce7,#00d4ff);display:inline-block;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg, rgba(255,0,64,.12), rgba(255,100,100,.06));border:1px solid rgba(255,0,64,.12)}
  footer{padding:14px;text-align:center;color:var(--muted)}
  @media(max-width:920px){.wrap{grid-template-columns:1fr}.sidebar-hidden{display:none}}
</style>
</head>
<body>
<header>
  <div class="brand">N0rb1n</div>
  <div class="spacer"></div>
  <div class="top-info" id="topInfo">
    <div id="deviceTxt" class="tiny muted">Device: detecting‚Ä¶</div>
    <div id="onlineTxt" class="tiny muted">‚óè 0 online</div>
    <div id="userArea" class="tiny muted">Not signed in</div>
    <button class="btn" id="toggleSidebar">Toggle Menu</button>
  </div>
</header>

<div class="wrap">
  <aside id="sidebar">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <strong>Menu</strong>
      <button class="btn ghost" id="closeMenu">Close</button>
    </div>
    <nav id="menu">
      <a href="#" data-page="home" class="active">üè† Home</a>
      <a href="#" data-page="paste">üìÑ Create Paste</a>
      <a href="#" data-page="recent">üïí Recent Pastes</a>
      <a href="#" data-page="top">‚≠ê Top Mentions (with images)</a>
      <a href="#" data-page="chat">üí¨ Global Chat</a>
      <a href="#" data-page="friends">üë• Friends</a>
      <a href="#" data-page="messages">‚úâÔ∏è Messages</a>
      <a href="#" data-page="account">üë§ My Account</a>
      <a href="#" data-page="signin">üÜï Sign Up</a>
      <a href="#" data-page="login">üîê Log In</a>
    </nav>
    <div style="margin-top:12px" class="card">
      <div class="tiny muted">Device</div>
      <div id="deviceBox" style="margin-top:6px">Detecting‚Ä¶</div>
    </div>
  </aside>

  <main>
    <!-- HOME -->
    <section id="page-home" class="card page">
      <h3>Welcome ‚Äî Home</h3>
      <label>Search titles</label>
      <input id="q" placeholder="Search pastes by title‚Ä¶"/>
      <div id="homeResults" style="margin-top:10px"></div>
    </section>

    <!-- PASTE -->
    <section id="page-paste" class="card page" style="display:none">
      <h3>Create a Paste</h3>
      <label>Title</label>
      <input id="pasteTitle" />
      <label style="margin-top:8px">Image URL (optional ‚Äî will show in Top Mentions only)</label>
      <input id="pasteImage" placeholder="https://... (optional)"/>
      <label style="margin-top:8px">Content</label>
      <textarea id="pasteContent" rows="6"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px"><button id="savePaste" class="btn">Save Paste</button><div id="pasteMsg" class="tiny muted"></div></div>
    </section>

    <!-- RECENT -->
    <section id="page-recent" class="card page" style="display:none">
      <h3>Recent Pastes</h3>
      <div id="recentList" class="list" style="margin-top:8px"></div>
    </section>

    <!-- TOP -->
    <section id="page-top" class="card page" style="display:none">
      <h3>Top Mentions (images only shown here)</h3>
      <div id="topList" class="list" style="margin-top:8px"></div>
    </section>

    <!-- CHAT -->
    <section id="page-chat" class="card page" style="display:none">
      <h3>Global Chat</h3>
      <div id="chatArea" style="border:1px solid rgba(255,255,255,.04);padding:8px;max-height:320px;overflow:auto;border-radius:8px;margin-top:8px"></div>
      <div id="emojiBar" style="display:flex;gap:6px;flex-wrap:wrap;margin:8px 0"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chatInput" placeholder="Say something‚Ä¶"/>
        <button id="sendChat" class="btn">Send</button>
      </div>
    </section>

    <!-- FRIENDS -->
    <section id="page-friends" class="card page" style="display:none">
      <h3>Friends & Requests</h3>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="flex:1">
          <div class="tiny muted">Incoming</div>
          <div id="incomingReq" class="list" style="margin-top:8px"></div>
        </div>
        <div style="flex:1">
          <div class="tiny muted">Your Friends</div>
          <div id="friendsList" class="list" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- MESSAGES -->
    <section id="page-messages" class="card page" style="display:none">
      <h3>Private Messages</h3>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="width:260px">
          <div class="tiny muted">Threads</div>
          <div id="threadList" style="margin-top:8px"></div>
        </div>
        <div style="flex:1">
          <div id="dmHeader" class="tiny muted">Select a thread</div>
          <div id="dmArea" style="border:1px solid rgba(255,255,255,.04);padding:8px;max-height:300px;overflow:auto;border-radius:8px;margin-top:8px"></div>
          <div style="display:flex;gap:8px;margin-top:8px"><input id="dmInput" placeholder="Message‚Ä¶"/><button id="dmSend" class="btn">Send</button></div>
        </div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="page-account" class="card page" style="display:none">
      <h3>My Account</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="myAvatar" class="avatar">?</div>
        <div>
          <div id="myName" style="font-weight:700">‚Äî</div>
          <div class="tiny muted" id="myLastLogin">Last login: ‚Äî</div>
          <div class="tiny muted" id="myDevice">Device: ‚Äî</div>
        </div>
      </div>

      <hr style="margin:12px 0;border:0;border-top:1px solid rgba(255,255,255,.03)" />
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="editAvatarBtn" class="btn">Edit Avatar (URL)</button>
        <button id="changePassBtn" class="btn ghost">Change Password</button>
        <button id="logoutBtn" class="btn">Log Out</button>
        <button id="deleteBtn" class="btn danger">Delete Account</button>
      </div>

      <div id="myStats" style="margin-top:12px">
        <div class="tiny muted">Friends: <span id="myFriendCount">0</span> ‚Äî Pending: <span id="myPendingCount">0</span></div>
        <h4 style="margin-top:10px">My Recent Pastes</h4>
        <div id="myPastes" class="list" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- SIGNUP -->
    <section id="page-signin" class="card page" style="display:none">
      <h3>Create Account</h3>
      <label>Username</label>
      <input id="suUser" />
      <label style="margin-top:8px">Password</label>
      <input id="suPass" type="password" />
      <div style="margin-top:8px;display:flex;gap:8px"><button id="suBtn" class="btn">Create account</button><div id="suMsg" class="tiny muted"></div></div>
    </section>

    <!-- LOGIN -->
    <section id="page-login" class="card page" style="display:none">
      <h3>Log In</h3>
      <label>Username</label>
      <input id="liUser" />
      <label style="margin-top:8px">Password</label>
      <input id="liPass" type="password" />
      <div style="margin-top:8px;display:flex;gap:8px"><button id="liBtn" class="btn">Log In</button><div id="liMsg" class="tiny muted"></div></div>
    </section>

  </main>
</div>
<footer>Single-file app ¬∑ All features active ¬∑ Data persists in this browser</footer>

<script>
/* ======= Simple DB in localStorage ======= */
const LS = { get(k,d){try{return JSON.parse(localStorage.getItem(k))||d}catch(e){return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
const DB = {
  users: LS.get('n_users', {}), // username -> {pass, avatar, friends:[], req:[], out:[], pastes:[], lastLogin:ts, device}
  chats: LS.get('n_chats', []),  // global chat messages
  dms: LS.get('n_dms', {}),     // convoId -> {between:[a,b], msgs:[]}
};
let STATE = { current: LS.get('n_current', null), activeDM: null };

/* ======= Helpers ======= */
const q = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2,9);
function saveAll(){ LS.set('n_users', DB.users); LS.set('n_chats', DB.chats); LS.set('n_dms', DB.dms); LS.set('n_current', STATE.current); }
function escape(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

/* ======= Routing (menu) ======= */
q('#menu').addEventListener('click', e=>{
  const a = e.target.closest('a[data-page]');
  if(!a) return; const page = a.dataset.page; navigate(page, true);
});
function navigate(page, redirect){ qAll('.page').forEach(el=>el.style.display='none'); const el = q('#page-'+page); if(el){ el.style.display='block'; qAll('#menu a').forEach(a=>a.classList.toggle('active', a.dataset.page===page)); }
  if(redirect){ const url = new URL(location); url.searchParams.set('page', page); history.pushState({},'',url); }
  // page-specific hooks
  if(page==='recent') renderRecent();
  if(page==='top') renderTop();
  if(page==='chat') renderChat();
  if(page==='friends') renderFriends();
  if(page==='messages') renderThreads();
  if(page==='account') renderAccount();
}
// init from url
(function(){ const u = new URL(location).searchParams.get('page')||'home'; navigate(u,false); })();

/* ======= Device detection ======= */
function detectDevice(){
  const ua = navigator.userAgent||''; const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
  let type = mobile? (/Android/i.test(ua)?'Android':'iOS') : 'Desktop';
  let vm = false;
  try{ const gl = document.createElement('canvas').getContext('webgl'); if(gl){ const dbg = gl.getExtension('WEBGL_debug_renderer_info'); if(dbg){ const v = gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL)||''; if(/SwiftShader|VirtualBox|VMware|Virtual GPU|Microsoft Basic Render/i.test(v)) vm=true; } } }catch(e){}
  const vp = mobile && (navigator.maxTouchPoints===0 || Math.max(screen.width,screen.height)>2000);
  const flags = []; if(vm) flags.push('VM'); if(vp) flags.push('VP');
  q('#deviceBox').textContent = flags.length? `${type} ‚Ä¢ ${flags.join(' + ')}` : type;
  q('#deviceTxt').textContent = 'Device: '+ (flags.length? `${type} ‚Ä¢ ${flags.join(' + ')}` : type);
}
detectDevice();

/* ======= Menu controls ======= */
q('#toggleSidebar').addEventListener('click', ()=> q('#sidebar').classList.toggle('sidebar-hidden'));
q('#closeMenu').addEventListener('click', ()=> q('#sidebar').classList.add('sidebar-hidden'));

/* ======= Sign Up / Log In / Accounts ======= */
q('#suBtn').addEventListener('click', ()=>{
  const u = (q('#suUser').value||'').trim(); const p = (q('#suPass').value||'').trim(); const msg = q('#suMsg'); msg.style.color='';
  if(!u||!p){ msg.textContent='Fill username & password'; return }
  if(DB.users[u]){ msg.style.color='var(--muted)'; msg.textContent='Account already exists (you are not signed in).'; return }
  DB.users[u] = { pass:p, avatar:'', friends:[], req:[], out:[], pastes:[], lastLogin: Date.now(), device: q('#deviceBox').textContent };
  saveAll(); msg.style.color='var(--good)'; msg.textContent='Account created';
});

q('#liBtn').addEventListener('click', ()=>{
  const u = (q('#liUser').value||'').trim(); const p = (q('#liPass').value||'').trim(); const msg = q('#liMsg'); msg.style.color='';
  if(!u||!p){ msg.textContent='Enter username & password'; return }
  const rec = DB.users[u]; if(!rec){ msg.textContent='Account isn\'t existing.'; return }
  if(rec.pass !== p){ msg.textContent='The account password is incorrect.'; return }
  STATE.current = u; DB.users[u].lastLogin = Date.now(); DB.users[u].device = q('#deviceBox').textContent; saveAll(); msg.style.color='var(--good)'; msg.textContent='Logged in'; updateTopUser(); navigate('home');
});

function logout(){ STATE.current = null; saveAll(); updateTopUser(); navigate('home'); }
q('#logoutBtn').addEventListener('click', ()=>{ logout(); });

function deleteAccount(){ if(!STATE.current) return; if(!confirm('Delete account permanently?')) return; const u = STATE.current; // remove associated dms and clean up
  // remove user from other users' friends/requests
  Object.keys(DB.users).forEach(other=>{
    if(other===u) return; DB.users[other].friends = (DB.users[other].friends||[]).filter(x=>x!==u); DB.users[other].req = (DB.users[other].req||[]).filter(x=>x!==u); DB.users[other].out = (DB.users[other].out||[]).filter(x=>x!==u);
  });
  // remove dms
  Object.keys(DB.dms).forEach(id=>{ if(id.includes('|')){ const parts=id.split('|'); if(parts.includes(u)) delete DB.dms[id]; }});
  delete DB.users[u]; STATE.current=null; saveAll(); updateTopUser(); navigate('home'); alert('Account deleted'); }
q('#deleteBtn').addEventListener('click', deleteAccount);

/* ======= Update top bar user */
function updateTopUser(){ q('#myName').textContent = STATE.current||'‚Äî'; q('#userArea').textContent = STATE.current? `Signed in: ${STATE.current}` : 'Not signed in'; q('#myAvatar').textContent = STATE.current? (DB.users[STATE.current].avatar? '': (STATE.current[0]||'?').toUpperCase()) : '?'; if(STATE.current && DB.users[STATE.current].avatar){ q('#myAvatar').style.backgroundImage = `url(${DB.users[STATE.current].avatar})`; q('#myAvatar').textContent=''; q('#myAvatar').style.backgroundSize='cover'; } else { q('#myAvatar').style.backgroundImage=''; q('#myAvatar').style.background='linear-gradient(90deg,#6c5ce7,#00d4ff)'; }
  q('#myLastLogin').textContent = STATE.current? 'Last login: '+ new Date(DB.users[STATE.current].lastLogin).toLocaleString() : 'Last login: ‚Äî'; q('#myDevice').textContent = STATE.current? 'Device: '+(DB.users[STATE.current].device||'‚Äî') : 'Device: ‚Äî';
  q('#myFriendCount').textContent = STATE.current? (DB.users[STATE.current].friends||[]).length : 0; q('#myPendingCount').textContent = STATE.current? (DB.users[STATE.current].req||[]).length : 0; saveAll(); }
updateTopUser();

/* ======= Avatar edit & change password ======= */
q('#editAvatarBtn').addEventListener('click', ()=>{
  if(!STATE.current){ alert('Log in first'); return }
  const url = prompt('Enter image URL for avatar (blank to remove):', DB.users[STATE.current].avatar||'') || '';
  DB.users[STATE.current].avatar = url.trim(); saveAll(); updateTopUser(); renderAccount(); });
q('#changePassBtn').addEventListener('click', ()=>{
  if(!STATE.current){ alert('Log in first'); return }
  const cur = prompt('Enter current password:'); if(cur===null) return; if(cur!==DB.users[STATE.current].pass){ alert('Current password incorrect'); return }
  const np = prompt('Enter new password:'); if(!np) return; DB.users[STATE.current].pass = np; saveAll(); alert('Password changed'); });

/* ======= Pastes (with optional image available only in Top Mentions) ======= */
q('#savePaste').addEventListener('click', ()=>{
  const t = (q('#pasteTitle').value||'').trim(); const b = (q('#pasteContent').value||'').trim(); const img = (q('#pasteImage').value||'').trim(); if(!t||!b){ q('#pasteMsg').textContent='Title & content required'; return }
  const author = STATE.current||'anonymous'; const paste = { id: uid(), title:t, body:b, image: img||'', by: author, at: Date.now() };
  // store per-user and global
  DB.users[author] = DB.users[author] || { pass:'', avatar:'', friends:[], req:[], out:[], pastes:[], lastLogin:0, device:'' };
  DB.users[author].pastes = DB.users[author].pastes||[]; DB.users[author].pastes.unshift(paste);
  // also global pastes list for search & recent
  DB._pastes = DB._pastes||[]; DB._pastes.unshift(paste);
  saveAll(); q('#pasteMsg').style.color='var(--good)'; q('#pasteMsg').textContent='Saved'; setTimeout(()=>{ q('#pasteMsg').textContent=''; },1600); renderRecent(); renderTop(); });

function renderRecent(){ const box=q('#recentList'); box.innerHTML=''; (DB._pastes||[]).slice(0,40).forEach(p=>{ const el=document.createElement('div'); el.className='item'; el.innerHTML = `<div style="flex:1"><b>${escape(p.title)}</b><div class='tiny muted'>by ${escape(p.by)} ‚Ä¢ ${new Date(p.at).toLocaleString()}</div><div style='margin-top:6px'>${escape(p.body)}</div></div>`; box.appendChild(el); }); }
function renderTop(){ const box=q('#topList'); box.innerHTML=''; const freq={}; (DB._pastes||[]).forEach(p=>{ const key=p.title.toLowerCase(); freq[key]=freq[key]||{count:0, items:[]}; freq[key].count++; freq[key].items.push(p); }); Object.entries(freq).sort((a,b)=>b[1].count-a[1].count).slice(0,40).forEach(([t,v])=>{ // show title + one image if available in any paste
  const pWithImg = v.items.find(x=>x.image);
  const el=document.createElement('div'); el.className='item'; el.innerHTML = `<div style='display:flex;gap:8px;align-items:center;'><div style='width:80px;height:60px;flex-shrink:0'>${pWithImg?`<img src="${escape(pWithImg.image)}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`:'<div style="width:100%;height:100%;background:linear-gradient(90deg,#333,#222);border-radius:8px"></div>'}</div><div style='flex:1'><b>${escape(v.items[0].title)}</b><div class="tiny muted">${v.count} mentions</div></div></div>`; box.appendChild(el); }); }

/* ======= Global Chat ======= */
q('#sendChat').addEventListener('click', ()=>{
  if(!STATE.current){ alert('Log in to chat'); return }
  const v=(q('#chatInput').value||'').trim();
  if(!v) return;
  DB.chats.push({id:uid(), by:STATE.current, body:v, at:Date.now()});
  saveAll();
  q('#chatInput').value='';
  renderChat();
});
q('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); q('#sendChat').click(); }});
// Emoji bar (classic 2000s-style set)
const EMOJIS = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üôÇ','üòâ','üòç','üòõ','üòú','üò¢','üò≠','üò°','üòÆ','üòé','üëç','üëé','‚ù§Ô∏è','üî•','üéâ'];
(function(){ const bar=q('#emojiBar'); if(!bar) return; EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.className='btn ghost'; b.style.padding='4px 8px'; b.textContent=e; b.addEventListener('click',()=>{ const i=q('#chatInput'); i.value=(i.value||'')+e; i.focus(); }); bar.appendChild(b); }); })();

function renderChat(){
  const box=q('#chatArea');
  box.innerHTML='';
  DB.chats.slice(-200).forEach(m=>{
    const me = DB.users[m.by]||{};
    const avatar = me.avatar
      ? `<div class='avatar' style="width:34px;height:34px;font-size:14px;background-image:url(${escape(me.avatar)});background-size:cover"></div>`
      : `<div class='avatar' style='width:34px;height:34px;font-size:14px'>${escape((m.by||' ')[0]||'?').toUpperCase()}</div>`;
    const el=document.createElement('div');
    el.style.margin='6px 0';
    el.innerHTML = `<div style='display:flex;gap:8px;align-items:center'>
        <button class='btn ghost' data-add='${escape(m.by)}' title='Add friend' style='padding:0;background:transparent;border:0'>${avatar}</button>
        <div><b>${escape(m.by)}</b><div class='tiny muted'>${new Date(m.at).toLocaleTimeString()}</div></div>
      </div>
      <div style='margin-left:42px'>${escape(m.body)}</div>`;
    box.appendChild(el);
  });
  box.scrollTop=box.scrollHeight;
}
// Add-friend via avatar click in chat
q('#chatArea').addEventListener('click', e=>{
  const b=e.target.closest('button[data-add]');
  if(!b) return;
  const target=b.dataset.add;
  if(!STATE.current){ alert('Log in first'); return }
  if(target===STATE.current){ alert("That's you üôÇ"); return }
  sendFriend(STATE.current, target);
  alert('Friend request sent to '+target);
});

/* ======= Friends (requests accept/deny) ======= */
function renderFriends(){ const inc=q('#incomingReq'); const fl=q('#friendsList'); inc.innerHTML=''; fl.innerHTML=''; if(!STATE.current){ inc.innerHTML='<div class="tiny muted">Log in to manage friends</div>'; return }
  const me = DB.users[STATE.current]; (me.req||[]).forEach(u=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div style='flex:1'><b>${escape(u)}</b><div class='tiny muted'>requested</div></div><div><button class='btn' data-acc='${u}'>Accept</button><button class='btn ghost' data-deny='${u}'>Deny</button></div>`; inc.appendChild(d); });
  (me.friends||[]).forEach(u=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div style='flex:1'><b>${escape(u)}</b></div><div><button class='btn' data-dm='${u}'>Message</button></div>`; fl.appendChild(d); }); }
q('#incomingReq').addEventListener('click', e=>{ const a=e.target.closest('button[data-acc]'); const d=e.target.closest('button[data-deny]'); if(a){ acceptReq(a.dataset.acc) } if(d){ denyReq(d.dataset.deny) } });
q('#friendsList').addEventListener('click', e=>{ const b=e.target.closest('button[data-dm]'); if(b){ startDM(b.dataset.dm); navigate('messages',true); } });
function sendFriend(from,to){ if(!DB.users[to] || !from) return; if(DB.users[to].req.includes(from) || DB.users[to].friends.includes(from)) return; DB.users[to].req.push(from); DB.users[from].out.push(to); saveAll(); renderFriends(); }
function acceptReq(u){ if(!STATE.current) return; const me=DB.users[STATE.current]; me.req = (me.req||[]).filter(x=>x!==u); me.friends = me.friends||[]; if(!me.friends.includes(u)) me.friends.push(u); const other = DB.users[u]; other.out = (other.out||[]).filter(x=>x!==STATE.current); other.friends = other.friends||[]; if(!other.friends.includes(STATE.current)) other.friends.push(STATE.current); saveAll(); renderFriends(); }
function denyReq(u){ if(!STATE.current) return; const me=DB.users[STATE.current]; me.req = (me.req||[]).filter(x=>x!==u); const other = DB.users[u]; other.out = (other.out||[]).filter(x=>x!==STATE.current); saveAll(); renderFriends(); }

/* ======= DMs ======= */
function convo(a,b){ return [a,b].sort().join('|'); }
function ensureThread(a,b){ const id = convo(a,b); DB.dms[id] = DB.dms[id]||{between:[a,b], msgs:[]}; saveAll(); return id }
function renderThreads(){ const list=q('#threadList'); list.innerHTML=''; if(!STATE.current){ list.textContent='Log in to see threads'; return } Object.entries(DB.dms).filter(([id,th])=> th.between.includes(STATE.current)).sort((a,b)=> (b[1].msgs.at(-1)?.at||0)-(a[1].msgs.at(-1)?.at||0)).forEach(([id,th])=>{ const other = th.between.find(x=>x!==STATE.current); const el=document.createElement('div'); el.className='item'; el.dataset.id=id; el.innerHTML=`<div style='flex:1'><b>${escape(other)}</b><div class='tiny muted'>${th.msgs.at(-1)?.body||'‚Äî'}</div></div><div><button class='btn' data-open='${id}'>Open</button></div>`; list.appendChild(el); }); }
q('#threadList').addEventListener('click', e=>{ const b = e.target.closest('button[data-open]'); if(b){ STATE.activeDM = b.dataset.open; renderDM(STATE.activeDM); } });
function renderDM(id){ const area=q('#dmArea'); area.innerHTML=''; if(!id) return; const th=DB.dms[id]; const other = th.between.find(x=>x!==STATE.current); q('#dmHeader').textContent = `Chat with ${other}`; th.msgs.forEach(m=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML = `<div style='flex:1'><b>${escape(m.by)}</b><div class='tiny muted'>${new Date(m.at).toLocaleTimeString()}</div>${escape(m.body)}</div>`; area.appendChild(d); }); area.scrollTop=area.scrollHeight; }
q('#dmSend').addEventListener('click', ()=>{ if(!STATE.current||!STATE.activeDM){ alert('Pick a thread'); return } const v=(q('#dmInput').value||'').trim(); if(!v) return; DB.dms[STATE.activeDM].msgs.push({id:uid(),by:STATE.current,body:v,at:Date.now()}); saveAll(); q('#dmInput').value=''; renderDM(STATE.activeDM); renderThreads(); });
q('#dmInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); q('#dmSend').click(); }}); return } const v=(q('#dmInput').value||'').trim(); if(!v) return; DB.dms[STATE.activeDM].msgs.push({id:uid(),by:STATE.current,body:v,at:Date.now()}); saveAll(); q('#dmInput').value=''; renderDM(STATE.activeDM); renderThreads(); });
function startDM(user){ if(!STATE.current) return; const id = ensureThread(STATE.current, user); STATE.activeDM = id; renderThreads(); renderDM(id); }

/* ======= Account page render ======= */
function renderAccount(){ if(!STATE.current){ navigate('login'); return } updateTopUser(); const me=DB.users[STATE.current]; q('#myPastes').innerHTML = (me.pastes||[]).slice(0,10).map(p=>`<div class='item'><div style='flex:1'><b>${escape(p.title)}</b><div class='tiny muted'>${new Date(p.at).toLocaleString()}</div></div>${p.image?`<div style='width:80px;height:60px;flex-shrink:0'><img src='${escape(p.image)}' style='width:100%;height:100%;object-fit:cover;border-radius:8px' /></div>`:''}</div>`).join(''); }

/* ======= Render helpers & boot ======= */
function renderHome(){ const qv=(q('#q').value||'').toLowerCase(); const res=(DB._pastes||[]).filter(p=>p.title.toLowerCase().includes(qv)); q('#homeResults').innerHTML = res.slice(0,30).map(p=>`<div class='item'><div style='flex:1'><b>${escape(p.title)}</b><div class='tiny muted'>by ${escape(p.by)} ‚Ä¢ ${new Date(p.at).toLocaleString()}</div><div style='margin-top:6px'>${escape(p.body)}</div></div></div>`).join(''); }
q('#q').addEventListener('input', renderHome);
/* page hook calls renderTop() directly */ // no-op, page hook handles it by calling renderTop directly

/* ======= Presence & online count (simple) ======= */
function heartbeat(){ if(STATE.current) DB.users[STATE.current].lastSeen = Date.now(); LS.set('n_users', DB.users); const now = Date.now(); let count = 0; Object.values(DB.users||{}).forEach(u=>{ if(u.lastSeen && now - u.lastSeen < 15000) count++; }); q('#onlineTxt').textContent = `‚óè ${count} online`; }
setInterval(heartbeat,4000);

/* ======= Initial render actions ======= */
renderRecent(); renderTop(); renderChat(); renderThreads(); updateTopUser();

/* ensure DB structures exist */
DB._pastes = DB._pastes || [];

/* Expose some global actions for demo ease */
// Globals removed in full version
</script>
</body>
</html>
